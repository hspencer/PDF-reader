<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF a Audiolibro con IA</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF.js library from Mozilla to parse PDF files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Lora Serif Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Lora', serif;
        }
        #text-content::-webkit-scrollbar, #modal-content::-webkit-scrollbar {
            width: 8px;
        }
        #text-content::-webkit-scrollbar-track, #modal-content::-webkit-scrollbar-track {
            background: #f5f5f4;
        }
        #text-content::-webkit-scrollbar-thumb, #modal-content::-webkit-scrollbar-thumb {
            background-color: #d6d3d1;
            border-radius: 10px;
            border: 2px solid #f5f5f4;
        }
        #pdf-input { display: none; }
        input[type=range]::-webkit-slider-thumb {
           -webkit-appearance: none;
           appearance: none;
           width: 16px;
           height: 16px;
           background: #c2410c;
           cursor: pointer;
           border-radius: 50%;
           margin-top: -6px;
        }
    </style>
</head>
<body class="bg-stone-100 text-stone-800 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl bg-white rounded-lg shadow-lg border border-stone-200 p-6 md:p-8 space-y-6 relative">
        <!-- Settings Icon -->
        <button id="settings-btn" class="absolute top-4 right-4 text-stone-400 hover:text-orange-700 transition-colors">
            <i class="fas fa-cog fa-lg"></i>
        </button>

        <!-- Header -->
        <div class="text-center border-b border-stone-200 pb-4">
            <h1 class="text-3xl md:text-4xl font-semibold text-stone-700">Tu Lector de PDF Personal</h1>
            <p class="text-stone-500 mt-2">Convierte cualquier PDF en un audiolibro y obtén resúmenes con IA.</p>
        </div>

        <!-- File Upload Section -->
        <div id="upload-section" class="border-2 border-dashed border-stone-300 rounded-lg p-8 text-center hover:bg-stone-50 transition-colors">
            <label for="pdf-input" class="cursor-pointer">
                <i class="fas fa-file-pdf fa-3x text-stone-400 mb-4"></i>
                <h2 id="upload-text" class="text-xl font-medium text-stone-700">Selecciona un archivo PDF para comenzar</h2>
                <p id="file-name" class="text-orange-700 mt-2 font-medium"></p>
            </label>
            <input type="file" id="pdf-input" accept=".pdf">
        </div>

        <!-- Controls Section -->
        <div id="controls-section" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 bg-stone-50 p-6 rounded-lg border border-stone-200">
                <div class="flex items-center justify-center space-x-4">
                    <button id="play-pause-btn" class="w-16 h-16 bg-orange-600 hover:bg-orange-700 text-white rounded-full flex items-center justify-center text-3xl transition-all duration-300 shadow-sm">
                        <i id="play-pause-icon" class="fas fa-play"></i>
                    </button>
                    <button id="stop-btn" class="w-16 h-16 bg-stone-600 hover:bg-stone-700 text-white rounded-full flex items-center justify-center text-3xl transition-all duration-300 shadow-sm">
                        <i class="fas fa-stop"></i>
                    </button>
                </div>
                <div class="md:col-span-2 space-y-4">
                    <div>
                        <label for="voice-select" class="block text-sm font-medium text-stone-600 mb-1">Voz</label>
                        <select id="voice-select" class="w-full bg-white border border-stone-300 rounded-md p-2 focus:ring-2 focus:ring-orange-500 focus:outline-none focus:border-orange-500"></select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="rate-slider" class="block text-sm font-medium text-stone-600 mb-1">Velocidad: <span id="rate-value">1</span>x</label>
                            <input id="rate-slider" type="range" min="0.5" max="2" step="0.1" value="1" class="w-full h-1 bg-stone-300 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div>
                            <label for="pitch-slider" class="block text-sm font-medium text-stone-600 mb-1">Tono: <span id="pitch-value">1</span></label>
                            <input id="pitch-slider" type="range" min="0" max="2" step="0.1" value="1" class="w-full h-1 bg-stone-300 rounded-lg appearance-none cursor-pointer">
                        </div>
                    </div>
                </div>
            </div>
            <div id="status-display" class="text-center mt-4 text-stone-500">
                <p>Página <span id="current-page">0</span> de <span id="total-pages">0</span></p>
            </div>
        </div>

        <!-- Text Display Area and AI Actions -->
        <div id="text-display-section" class="hidden">
            <h3 class="text-lg font-medium mb-2 text-stone-600">Texto de la página actual:</h3>
            <textarea id="text-content" readonly class="w-full h-48 bg-stone-50 border border-stone-200 rounded-lg p-4 text-stone-700 resize-none focus:outline-none"></textarea>
            <div id="ai-actions-section" class="text-center space-x-2 sm:space-x-4 mt-4">
                <button id="summarize-btn" class="bg-stone-700 hover:bg-stone-800 text-white font-medium py-2 px-4 rounded-md transition-colors duration-300 text-sm sm:text-base shadow-sm">
                    ✨ Resumir Página
                </button>
                <button id="key-points-btn" class="bg-stone-700 hover:bg-stone-800 text-white font-medium py-2 px-4 rounded-md transition-colors duration-300 text-sm sm:text-base shadow-sm">
                    ✨ Puntos Clave
                </button>
            </div>
        </div>
    </div>

    <!-- Universal Modal -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl p-6 relative border border-stone-200">
            <button id="close-modal-btn" class="absolute top-3 right-4 text-stone-400 hover:text-stone-600 text-2xl">&times;</button>
            <h2 id="modal-title" class="text-2xl font-semibold text-orange-700 mb-4"></h2>
            
            <!-- Gemini Result View -->
            <div id="modal-gemini-view">
                <div id="modal-content" class="text-stone-700 max-h-[60vh] overflow-y-auto pr-4">
                    <div id="modal-loader" class="text-center hidden">
                         <svg class="animate-spin h-8 w-8 text-orange-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="mt-2 text-stone-500">Procesando con Gemini...</p>
                    </div>
                    <p id="modal-text" class="whitespace-pre-wrap"></p>
                </div>
            </div>

            <!-- API Key Settings View -->
            <div id="modal-settings-view" class="hidden">
                <p class="text-stone-600 mb-2">
                    Para usar las funciones de IA, necesitas una API Key de Google AI Studio. Es gratis y fácil de obtener.
                </p>
                <p class="mb-4">
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-orange-600 hover:underline">Obtén tu API Key aquí &rarr;</a>
                </p>
                <label for="api-key-input" class="block text-sm font-medium text-stone-600 mb-1">Tu API Key de Gemini</label>
                <input type="password" id="api-key-input" class="w-full bg-white border border-stone-300 rounded-md p-2 focus:ring-2 focus:ring-orange-500 focus:outline-none" placeholder="Pega tu clave aquí">
                <button id="save-api-key-btn" class="mt-4 w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-md transition-colors">Guardar Clave</button>
            </div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;

        // DOM Elements
        const allDOMElements = {
            pdfInput: document.getElementById('pdf-input'),
            uploadText: document.getElementById('upload-text'),
            fileNameDisplay: document.getElementById('file-name'),
            controlsSection: document.getElementById('controls-section'),
            textDisplaySection: document.getElementById('text-display-section'),
            playPauseBtn: document.getElementById('play-pause-btn'),
            playPauseIcon: document.getElementById('play-pause-icon'),
            stopBtn: document.getElementById('stop-btn'),
            voiceSelect: document.getElementById('voice-select'),
            rateSlider: document.getElementById('rate-slider'),
            pitchSlider: document.getElementById('pitch-slider'),
            rateValue: document.getElementById('rate-value'),
            pitchValue: document.getElementById('pitch-value'),
            currentPageDisplay: document.getElementById('current-page'),
            totalPagesDisplay: document.getElementById('total-pages'),
            textContent: document.getElementById('text-content'),
            summarizeBtn: document.getElementById('summarize-btn'),
            keyPointsBtn: document.getElementById('key-points-btn'),
            settingsBtn: document.getElementById('settings-btn'),
            modal: document.getElementById('modal'),
            closeModalBtn: document.getElementById('close-modal-btn'),
            modalTitle: document.getElementById('modal-title'),
            modalGeminiView: document.getElementById('modal-gemini-view'),
            modalSettingsView: document.getElementById('modal-settings-view'),
            modalLoader: document.getElementById('modal-loader'),
            modalText: document.getElementById('modal-text'),
            apiKeyInput: document.getElementById('api-key-input'),
            saveApiKeyBtn: document.getElementById('save-api-key-btn'),
        };

        // State variables
        let pdfDoc = null, currentPageNum = 1, isReading = false, isPaused = false;
        let utterance = null, voices = [], geminiApiKey = '';

        const synth = window.speechSynthesis;

        function populateVoiceList() {
            voices = synth.getVoices();
            allDOMElements.voiceSelect.innerHTML = '';
            voices.forEach((voice) => {
                if (voice.lang.startsWith('es') || voice.lang.startsWith('en')) {
                    const option = document.createElement('option');
                    option.textContent = `${voice.name} (${voice.lang})`;
                    if (voice.default && voice.lang.startsWith('es')) option.textContent += ' -- Default';
                    option.setAttribute('data-name', voice.name);
                    allDOMElements.voiceSelect.appendChild(option);
                }
            });
            const spanishVoice = Array.from(allDOMElements.voiceSelect.options).find(o => o.textContent.includes('(es'));
            if (spanishVoice) spanishVoice.selected = true;
        }

        populateVoiceList();
        if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = populateVoiceList;

        allDOMElements.pdfInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file || file.type !== 'application/pdf') return;
            handleStop();
            const fileReader = new FileReader();
            fileReader.onload = function() {
                const typedarray = new Uint8Array(this.result);
                allDOMElements.uploadText.textContent = 'Cargando PDF...';
                allDOMElements.fileNameDisplay.textContent = '';
                pdfjsLib.getDocument(typedarray).promise.then(pdf => {
                    pdfDoc = pdf;
                    allDOMElements.totalPagesDisplay.textContent = pdf.numPages;
                    currentPageNum = 1;
                    allDOMElements.currentPageDisplay.textContent = '1';
                    allDOMElements.uploadText.textContent = 'Archivo cargado:';
                    allDOMElements.fileNameDisplay.textContent = file.name;
                    allDOMElements.controlsSection.classList.remove('hidden');
                    allDOMElements.textDisplaySection.classList.remove('hidden');
                    getPageText(1).then(text => allDOMElements.textContent.value = text);
                }).catch(err => {
                    console.error("Error loading PDF:", err);
                    allDOMElements.uploadText.textContent = "Error al cargar el PDF.";
                });
            };
            fileReader.readAsArrayBuffer(file);
        });

        async function getPageText(pageNum) {
            if (!pdfDoc || pageNum < 1 || pageNum > pdfDoc.numPages) return '';
            const page = await pdfDoc.getPage(pageNum);
            const textContentObj = await page.getTextContent();
            return textContentObj.items.map(item => item.str).join(' ');
        }

        async function readPage(pageNum) {
            if (!isReading || pageNum > pdfDoc.numPages) {
                handleStop();
                return;
            }
            allDOMElements.currentPageDisplay.textContent = pageNum;
            const text = await getPageText(pageNum);
            allDOMElements.textContent.value = text;

            if (!text.trim()) {
                currentPageNum++;
                readPage(currentPageNum);
                return;
            }

            utterance = new SpeechSynthesisUtterance(text);
            const selectedVoiceName = allDOMElements.voiceSelect.selectedOptions[0].getAttribute('data-name');
            utterance.voice = voices.find(voice => voice.name === selectedVoiceName);
            utterance.pitch = parseFloat(allDOMElements.pitchSlider.value);
            utterance.rate = parseFloat(allDOMElements.rateSlider.value);
            utterance.onend = () => { if (isReading) { currentPageNum++; readPage(currentPageNum); } };
            utterance.onerror = (event) => { console.error('SpeechSynthesisUtterance.onerror', event); if (isReading) { currentPageNum++; readPage(currentPageNum); } };
            synth.speak(utterance);
        }

        function handlePlayPause() {
            if (!pdfDoc) return;
            if (!isReading) {
                isReading = true; isPaused = false;
                allDOMElements.playPauseIcon.classList.replace('fa-play', 'fa-pause');
                readPage(currentPageNum);
            } else if (isPaused) {
                isPaused = false;
                allDOMElements.playPauseIcon.classList.replace('fa-play', 'fa-pause');
                synth.resume();
            } else {
                isPaused = true;
                allDOMElements.playPauseIcon.classList.replace('fa-pause', 'fa-play');
                synth.pause();
            }
        }

        function handleStop() {
            isReading = false; isPaused = false;
            synth.cancel();
            allDOMElements.playPauseIcon.classList.replace('fa-pause', 'fa-play');
            currentPageNum = 1;
            if (pdfDoc) {
                allDOMElements.currentPageDisplay.textContent = '1';
                getPageText(1).then(text => allDOMElements.textContent.value = text);
            } else {
                allDOMElements.currentPageDisplay.textContent = '0';
                allDOMElements.totalPagesDisplay.textContent = '0';
            }
        }

        allDOMElements.playPauseBtn.addEventListener('click', handlePlayPause);
        allDOMElements.stopBtn.addEventListener('click', handleStop);
        allDOMElements.rateSlider.addEventListener('input', (e) => { allDOMElements.rateValue.textContent = parseFloat(e.target.value).toFixed(1); });
        allDOMElements.pitchSlider.addEventListener('input', (e) => { allDOMElements.pitchValue.textContent = parseFloat(e.target.value).toFixed(1); });

        // --- Modal & API Key Logic ---
        function showModal(type, title) {
            allDOMElements.modalTitle.textContent = title;
            if (type === 'gemini') {
                allDOMElements.modalGeminiView.classList.remove('hidden');
                allDOMElements.modalSettingsView.classList.add('hidden');
            } else if (type === 'settings') {
                allDOMElements.modalGeminiView.classList.add('hidden');
                allDOMElements.modalSettingsView.classList.remove('hidden');
                allDOMElements.apiKeyInput.value = geminiApiKey;
            }
            allDOMElements.modal.classList.remove('hidden');
        }

        function hideModal() { allDOMElements.modal.classList.add('hidden'); }
        function showLoader(show) {
            allDOMElements.modalLoader.classList.toggle('hidden', !show);
            allDOMElements.modalText.classList.toggle('hidden', show);
        }

        function loadApiKey() {
            geminiApiKey = localStorage.getItem('geminiApiKey') || '';
        }

        function saveApiKey() {
            geminiApiKey = allDOMElements.apiKeyInput.value.trim();
            if (geminiApiKey) {
                localStorage.setItem('geminiApiKey', geminiApiKey);
                alert('API Key guardada correctamente.');
                hideModal();
            } else {
                alert('Por favor, introduce una API Key válida.');
            }
        }

        allDOMElements.settingsBtn.addEventListener('click', () => showModal('settings', 'Ajustes de API'));
        allDOMElements.closeModalBtn.addEventListener('click', hideModal);
        allDOMElements.saveApiKeyBtn.addEventListener('click', saveApiKey);
        
        // --- Gemini API Call ---
        async function callGemini(prompt, title) {
            if (!geminiApiKey) {
                showModal('settings', 'Introduce tu API Key');
                return;
            }
            showModal('gemini', title);
            showLoader(true);
            allDOMElements.modalText.textContent = '';

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiApiKey}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.error?.message || 'Error en la respuesta de la API.');
                }
                allDOMElements.modalText.textContent = result.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                allDOMElements.modalText.textContent = `Hubo un error al contactar a la IA. Verifica tu API Key y la consola para más detalles.\n\nError: ${error.message}`;
            } finally {
                showLoader(false);
            }
        }

        allDOMElements.summarizeBtn.addEventListener('click', () => {
            const pageText = allDOMElements.textContent.value;
            if (!pageText.trim()) return;
            const prompt = `Por favor, resume el siguiente texto extraído de un documento PDF. Sé conciso y claro, enfocándote en las ideas principales. El resumen debe estar en español.\n\nTexto a resumir:\n---\n${pageText}`;
            callGemini(prompt, '✨ Resumen de la Página');
        });

        allDOMElements.keyPointsBtn.addEventListener('click', async () => {
            if (!pdfDoc) return;
            if (!geminiApiKey) {
                showModal('settings', 'Introduce tu API Key');
                return;
            }
            showModal('gemini', '✨ Puntos Clave del Documento');
            showLoader(true);
            try {
                let fullText = '';
                const numPagesToProcess = Math.min(pdfDoc.numPages, 10);
                for (let i = 1; i <= numPagesToProcess; i++) {
                    fullText += await getPageText(i) + '\n\n';
                }
                if (!fullText.trim()) {
                    allDOMElements.modalText.textContent = "No se pudo extraer texto del documento.";
                    showLoader(false);
                    return;
                }
                const prompt = `Analiza el siguiente texto, que corresponde a las primeras ${numPagesToProcess} páginas de un documento PDF. Extrae y lista los puntos clave o un resumen ejecutivo. La respuesta debe estar en español y ser fácil de leer, usando viñetas si es apropiado.\n\nTexto a analizar:\n---\n${fullText}`;
                // We call the main function here, which handles the modal and API call
                await callGemini(prompt, '✨ Puntos Clave del Documento');
            } catch (error) {
                console.error("Error getting key points:", error);
                allDOMElements.modalText.textContent = "Hubo un error al procesar el documento para obtener los puntos clave.";
                showLoader(false);
            }
        });
        
        // Initial load
        loadApiKey();

    </script>
</body>
</html>
