<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF a Audiolibro con IA</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF.js library from Mozilla to parse PDF files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Lora Serif Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Lora', serif;
        }
        /* Custom scrollbar for the text area and modal */
        #text-content::-webkit-scrollbar, #modal-content::-webkit-scrollbar {
            width: 8px;
        }
        #text-content::-webkit-scrollbar-track, #modal-content::-webkit-scrollbar-track {
            background: #f5f5f4; /* stone-100 */
        }
        #text-content::-webkit-scrollbar-thumb, #modal-content::-webkit-scrollbar-thumb {
            background-color: #d6d3d1; /* stone-300 */
            border-radius: 10px;
            border: 2px solid #f5f5f4; /* stone-100 */
        }
        /* Hide default file input */
        #pdf-input {
            display: none;
        }
        /* Custom slider thumb */
        input[type=range]::-webkit-slider-thumb {
           -webkit-appearance: none;
           appearance: none;
           width: 16px;
           height: 16px;
           background: #c2410c; /* orange-700 */
           cursor: pointer;
           border-radius: 50%;
           margin-top: -6px; /* You need to specify a margin in Chrome, but not in Firefox */
        }
    </style>
</head>
<body class="bg-stone-100 text-stone-800 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl bg-white rounded-lg shadow-lg border border-stone-200 p-6 md:p-8 space-y-6">
        <!-- Header -->
        <div class="text-center border-b border-stone-200 pb-4">
            <h1 class="text-3xl md:text-4xl font-semibold text-stone-700">Tu Lector de PDF Personal</h1>
            <p class="text-stone-500 mt-2">Convierte cualquier PDF en un audiolibro y obtén resúmenes con IA.</p>
        </div>

        <!-- File Upload Section -->
        <div id="upload-section" class="border-2 border-dashed border-stone-300 rounded-lg p-8 text-center hover:bg-stone-50 transition-colors">
            <label for="pdf-input" class="cursor-pointer">
                <i class="fas fa-file-pdf fa-3x text-stone-400 mb-4"></i>
                <h2 id="upload-text" class="text-xl font-medium text-stone-700">Selecciona un archivo PDF para comenzar</h2>
                <p id="file-name" class="text-orange-700 mt-2 font-medium"></p>
            </label>
            <input type="file" id="pdf-input" accept=".pdf">
        </div>

        <!-- Controls Section -->
        <div id="controls-section" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 bg-stone-50 p-6 rounded-lg border border-stone-200">
                <!-- Main Play/Stop Controls -->
                <div class="flex items-center justify-center space-x-4">
                    <button id="play-pause-btn" class="w-16 h-16 bg-orange-600 hover:bg-orange-700 text-white rounded-full flex items-center justify-center text-3xl transition-all duration-300 shadow-sm">
                        <i id="play-pause-icon" class="fas fa-play"></i>
                    </button>
                    <button id="stop-btn" class="w-16 h-16 bg-stone-600 hover:bg-stone-700 text-white rounded-full flex items-center justify-center text-3xl transition-all duration-300 shadow-sm">
                        <i class="fas fa-stop"></i>
                    </button>
                </div>

                <!-- Voice and Speed Settings -->
                <div class="md:col-span-2 space-y-4">
                    <div>
                        <label for="voice-select" class="block text-sm font-medium text-stone-600 mb-1">Voz</label>
                        <select id="voice-select" class="w-full bg-white border border-stone-300 rounded-md p-2 focus:ring-2 focus:ring-orange-500 focus:outline-none focus:border-orange-500"></select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="rate-slider" class="block text-sm font-medium text-stone-600 mb-1">Velocidad: <span id="rate-value">1</span>x</label>
                            <input id="rate-slider" type="range" min="0.5" max="2" step="0.1" value="1" class="w-full h-1 bg-stone-300 rounded-lg appearance-none cursor-pointer">
                        </div>
                        <div>
                            <label for="pitch-slider" class="block text-sm font-medium text-stone-600 mb-1">Tono: <span id="pitch-value">1</span></label>
                            <input id="pitch-slider" type="range" min="0" max="2" step="0.1" value="1" class="w-full h-1 bg-stone-300 rounded-lg appearance-none cursor-pointer">
                        </div>
                    </div>
                </div>
            </div>
             <!-- Status Display -->
            <div id="status-display" class="text-center mt-4 text-stone-500">
                <p>Página <span id="current-page">0</span> de <span id="total-pages">0</span></p>
            </div>
        </div>

        <!-- Text Display Area and AI Actions -->
        <div id="text-display-section" class="hidden">
            <h3 class="text-lg font-medium mb-2 text-stone-600">Texto de la página actual:</h3>
            <textarea id="text-content" readonly class="w-full h-48 bg-stone-50 border border-stone-200 rounded-lg p-4 text-stone-700 resize-none focus:outline-none"></textarea>
            
            <!-- AI Actions Section -->
            <div id="ai-actions-section" class="text-center space-x-2 sm:space-x-4 mt-4">
                <button id="summarize-btn" class="bg-stone-700 hover:bg-stone-800 text-white font-medium py-2 px-4 rounded-md transition-colors duration-300 text-sm sm:text-base shadow-sm">
                    ✨ Resumir Página
                </button>
                <button id="key-points-btn" class="bg-stone-700 hover:bg-stone-800 text-white font-medium py-2 px-4 rounded-md transition-colors duration-300 text-sm sm:text-base shadow-sm">
                    ✨ Puntos Clave
                </button>
            </div>
        </div>
    </div>

    <!-- Gemini Result Modal -->
    <div id="gemini-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-2xl p-6 relative border border-stone-200">
            <button id="close-modal-btn" class="absolute top-3 right-4 text-stone-400 hover:text-stone-600 text-2xl">&times;</button>
            <h2 id="modal-title" class="text-2xl font-semibold text-orange-700 mb-4">Resultado de la IA</h2>
            <div id="modal-content" class="text-stone-700 max-h-[60vh] overflow-y-auto pr-4">
                <!-- Loading spinner -->
                <div id="modal-loader" class="text-center hidden">
                     <svg class="animate-spin h-8 w-8 text-orange-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-2 text-stone-500">Procesando con Gemini...</p>
                </div>
                <!-- Result text -->
                <p id="modal-text" class="whitespace-pre-wrap"></p>
            </div>
        </div>
    </div>

    <script>
        // Set the workerSrc for pdf.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;

        // DOM Elements
        const pdfInput = document.getElementById('pdf-input');
        const uploadText = document.getElementById('upload-text');
        const fileNameDisplay = document.getElementById('file-name');
        const controlsSection = document.getElementById('controls-section');
        const textDisplaySection = document.getElementById('text-display-section');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const playPauseIcon = document.getElementById('play-pause-icon');
        const stopBtn = document.getElementById('stop-btn');
        const voiceSelect = document.getElementById('voice-select');
        const rateSlider = document.getElementById('rate-slider');
        const pitchSlider = document.getElementById('pitch-slider');
        const rateValue = document.getElementById('rate-value');
        const pitchValue = document.getElementById('pitch-value');
        const currentPageDisplay = document.getElementById('current-page');
        const totalPagesDisplay = document.getElementById('total-pages');
        const textContent = document.getElementById('text-content');
        const summarizeBtn = document.getElementById('summarize-btn');
        const keyPointsBtn = document.getElementById('key-points-btn');
        const geminiModal = document.getElementById('gemini-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modalTitle = document.getElementById('modal-title');
        const modalLoader = document.getElementById('modal-loader');
        const modalText = document.getElementById('modal-text');

        // State variables
        let pdfDoc = null;
        let currentPageNum = 1;
        let isReading = false;
        let isPaused = false;
        let utterance = null;
        let voices = [];

        // --- Speech Synthesis Setup ---
        const synth = window.speechSynthesis;

        function populateVoiceList() {
            voices = synth.getVoices();
            voiceSelect.innerHTML = '';
            voices.forEach((voice) => {
                if (voice.lang.startsWith('es') || voice.lang.startsWith('en')) {
                    const option = document.createElement('option');
                    option.textContent = `${voice.name} (${voice.lang})`;
                    if (voice.default && voice.lang.startsWith('es')) {
                        option.textContent += ' -- Default';
                    }
                    option.setAttribute('data-lang', voice.lang);
                    option.setAttribute('data-name', voice.name);
                    voiceSelect.appendChild(option);
                }
            });
            const spanishVoice = Array.from(voiceSelect.options).find(o => o.getAttribute('data-lang').startsWith('es'));
            if (spanishVoice) {
                voiceSelect.value = spanishVoice.value;
            }
        }

        populateVoiceList();
        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = populateVoiceList;
        }

        // --- PDF Handling ---
        pdfInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file && file.type === 'application/pdf') {
                handleStop();
                const fileReader = new FileReader();
                fileReader.onload = function() {
                    const typedarray = new Uint8Array(this.result);
                    uploadText.textContent = 'Cargando PDF...';
                    fileNameDisplay.textContent = '';
                    
                    pdfjsLib.getDocument(typedarray).promise.then(pdf => {
                        pdfDoc = pdf;
                        totalPagesDisplay.textContent = pdf.numPages;
                        currentPageNum = 1;
                        currentPageDisplay.textContent = '1';
                        
                        uploadText.textContent = 'Archivo cargado:';
                        fileNameDisplay.textContent = file.name;
                        controlsSection.classList.remove('hidden');
                        textDisplaySection.classList.remove('hidden');
                        
                        getPageText(1).then(text => {
                            textContent.value = text;
                        });
                    }).catch(err => {
                        console.error("Error loading PDF:", err);
                        uploadText.textContent = "Error al cargar el PDF. Intenta con otro.";
                    });
                };
                fileReader.readAsArrayBuffer(file);
            }
        });

        async function getPageText(pageNum) {
            if (!pdfDoc || pageNum < 1 || pageNum > pdfDoc.numPages) return '';
            try {
                const page = await pdfDoc.getPage(pageNum);
                const textContentObj = await page.getTextContent();
                return textContentObj.items.map(item => item.str).join(' ');
            } catch (err) {
                console.error(`Error getting text from page ${pageNum}:`, err);
                return '';
            }
        }
        
        async function readPage(pageNum) {
            if (!isReading || pageNum > pdfDoc.numPages) {
                handleStop();
                return;
            }

            currentPageDisplay.textContent = pageNum;
            const text = await getPageText(pageNum);
            textContent.value = text;

            if (text.trim().length === 0) {
                console.log(`Page ${pageNum} is blank, skipping.`);
                currentPageNum++;
                readPage(currentPageNum);
                return;
            }

            utterance = new SpeechSynthesisUtterance(text);
            const selectedVoiceName = voiceSelect.selectedOptions[0].getAttribute('data-name');
            utterance.voice = voices.find(voice => voice.name === selectedVoiceName);
            utterance.pitch = parseFloat(pitchSlider.value);
            utterance.rate = parseFloat(rateSlider.value);
            
            utterance.onend = () => {
                if (isReading) {
                    currentPageNum++;
                    readPage(currentPageNum);
                }
            };
            
            utterance.onerror = (event) => {
                console.error('SpeechSynthesisUtterance.onerror', event);
                if (isReading) {
                    currentPageNum++;
                    readPage(currentPageNum);
                }
            };

            synth.speak(utterance);
        }

        // --- UI Controls Logic ---
        function handlePlayPause() {
            if (!pdfDoc) return;
            if (!isReading) {
                isReading = true;
                isPaused = false;
                playPauseIcon.classList.replace('fa-play', 'fa-pause');
                readPage(currentPageNum);
            } else {
                if (isPaused) {
                    isPaused = false;
                    playPauseIcon.classList.replace('fa-play', 'fa-pause');
                    synth.resume();
                } else {
                    isPaused = true;
                    playPauseIcon.classList.replace('fa-pause', 'fa-play');
                    synth.pause();
                }
            }
        }

        function handleStop() {
            isReading = false;
            isPaused = false;
            synth.cancel();
            playPauseIcon.classList.replace('fa-pause', 'fa-play');
            currentPageNum = 1;
            if (pdfDoc) {
                currentPageDisplay.textContent = '1';
                getPageText(1).then(text => textContent.value = text);
            } else {
                currentPageDisplay.textContent = '0';
                totalPagesDisplay.textContent = '0';
            }
        }

        playPauseBtn.addEventListener('click', handlePlayPause);
        stopBtn.addEventListener('click', handleStop);

        rateSlider.addEventListener('input', (e) => { rateValue.textContent = parseFloat(e.target.value).toFixed(1); });
        pitchSlider.addEventListener('input', (e) => { pitchValue.textContent = parseFloat(e.target.value).toFixed(1); });
        
        // --- Gemini API and Modal Logic ---
        
        function showModal(title) {
            modalTitle.textContent = title;
            geminiModal.classList.remove('hidden');
        }
        
        function hideModal() {
            geminiModal.classList.add('hidden');
        }

        function showLoader(show) {
            if (show) {
                modalLoader.classList.remove('hidden');
                modalText.classList.add('hidden');
            } else {
                modalLoader.classList.add('hidden');
                modalText.classList.remove('hidden');
            }
        }

        closeModalBtn.addEventListener('click', hideModal);

        async function callGemini(prompt) {
            showLoader(true);
            modalText.textContent = '';

            const apiKey = ""; // Provided by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{
                    role: "user",
                    parts: [{ text: prompt }]
                }]
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    modalText.textContent = text;
                } else {
                    throw new Error("Respuesta inválida de la API de Gemini.");
                }

            } catch (error) {
                console.error("Error calling Gemini API:", error);
                modalText.textContent = `Hubo un error al contactar a la IA. Por favor, inténtalo de nuevo.\n\nDetalles: ${error.message}`;
            } finally {
                showLoader(false);
            }
        }

        summarizeBtn.addEventListener('click', () => {
            const pageText = textContent.value;
            if (!pageText.trim()) {
                // Using a custom modal for alerts would be a good next step
                alert("No hay texto en la página actual para resumir.");
                return;
            }
            showModal('✨ Resumen de la Página');
            const prompt = `Por favor, resume el siguiente texto extraído de un documento PDF. Sé conciso y claro, enfocándote en las ideas principales. El resumen debe estar en español.\n\nTexto a resumir:\n---\n${pageText}`;
            callGemini(prompt);
        });

        keyPointsBtn.addEventListener('click', async () => {
            if (!pdfDoc) return;
            showModal('✨ Puntos Clave del Documento');
            showLoader(true);

            try {
                let fullText = '';
                // Limit to first 10 pages to avoid huge API calls
                const numPagesToProcess = Math.min(pdfDoc.numPages, 10); 
                for (let i = 1; i <= numPagesToProcess; i++) {
                    fullText += await getPageText(i) + '\n\n';
                }

                if (!fullText.trim()) {
                    modalText.textContent = "No se pudo extraer texto del documento.";
                    showLoader(false);
                    return;
                }
                
                const prompt = `Analiza el siguiente texto, que corresponde a las primeras ${numPagesToProcess} páginas de un documento PDF. Extrae y lista los puntos clave o un resumen ejecutivo. La respuesta debe estar en español y ser fácil de leer, usando viñetas si es apropiado.\n\nTexto a analizar:\n---\n${fullText}`;
                await callGemini(prompt);

            } catch (error) {
                console.error("Error getting key points:", error);
                modalText.textContent = "Hubo un error al procesar el documento para obtener los puntos clave.";
                showLoader(false);
            }
        });

    </script>
</body>
</html>
